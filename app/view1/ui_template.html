<div id="graphics" ng-init="checkSVG()">

    <!-- SVG FILE CONTENT BELOW -->

    <?xml version="1.0" encoding="utf-8"?>
    <svg viewBox="0 0 1280 800" width="640px" height="400px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <marker id="marker-0" viewBox="0 0 10 10" overflow="visible" orient="auto" refX="10" refY="5" markerWidth="10" markerHeight="10">
                <path d="M 5 0 L 10 10 L 0 10 L 5 0 Z" style="stroke-miterlimit: 7; fill: rgb(66, 66, 66);" transform="matrix(0, 1, -1, 0, 9.999885, 0)" bx:shape="triangle 0 0 10 10 0.5 0 1@05c4d4a2"/>
            </marker>
        </defs>
        <g>
            <title>Tank</title>
            <rect x="176.613" y="128.451" width="220" height="300" style="fill: rgb(224, 224, 224); stroke: rgb(117, 117, 117); vector-effect: non-scaling-stroke; stroke-width: 2px;"/>
            <path id="tank@cx_stroke" style="fill: rgb(224, 224, 224); stroke: rgb(117, 117, 117); vector-effect: non-scaling-stroke; stroke-width: 2px;" transform="matrix(1.633526, 0, 0, 0.77225, -668.189636, -347.961029)" d="M 517.165 616.914 A 67.339 67.339 0 1 1 651.843 616.914 L 584.504 616.914 Z" bx:shape="pie 584.504 616.914 0 67.339 270 90 1@b77ee557"/>
            <path style="fill: rgb(224, 224, 224); stroke: rgb(117, 117, 117); vector-effect: non-scaling-stroke; stroke-width: 2px;" transform="matrix(1.633526, 0, 0, 0.77225, -668.189636, -47.961182)" d="M 651.843 616.914 A 67.339 67.339 0 1 1 517.165 616.914 L 584.504 616.914 Z" bx:shape="pie 584.504 616.914 0 67.339 90 270 1@236ce6ad"/>
            <text style="fill: rgb(98, 98, 98); font-size: 26px; font-weight: 700; white-space: pre;" x="248.973" y="113.804"><title>Name</title>T-101</text>
            <path d="M 180.508 277.8 C 187.809 272.503 191.399 276.589 198.293 276.589 C 201.263 276.589 205.577 275.245 208.504 276.217 C 211.271 277.135 216.156 279.449 219.265 277.971 C 221.86 276.736 227.125 274.688 230.379 275.768 C 231.999 276.306 236.096 277.93 237.778 276.801 C 238.764 276.139 244.703 273.727 246.093 274.682 C 248.27 276.178 252.621 277.752 255.312 276.853 C 261.776 274.693 267.727 278.647 274.034 277.714 C 286.384 275.887 299.15 274.115 312.32 276.3 C 320.345 277.631 333.161 278.344 339.627 275.349 C 341.713 274.382 346.935 276.165 349.672 275.535 C 353.293 274.7 356.633 276.435 360.053 277.069 C 365.108 278.006 371.654 278.288 376.764 278.288 C 379.549 278.288 384.165 276.189 386.671 277.91 C 387.729 278.637 391.621 277.62 392.567 277.257 C 394.148 276.648 396.613 278.044 396.613 277.138" style="stroke-width: 3px; fill: none; vector-effect: non-scaling-stroke; stroke: rgb(40, 53, 147);"/>
        </g>
        <g>
            <title>Indicator</title>
            <rect x="396.613" y="128.451" width="30" height="300" style="fill: rgb(224, 224, 224); stroke: rgb(117, 117, 117); vector-effect: non-scaling-stroke; stroke-width: 2px;"/>
            <rect x="396.613" y="128.451" width="30" height="17.479" style="vector-effect: non-scaling-stroke; stroke-width: 2px; fill: rgb(33, 33, 33); stroke: rgb(33, 33, 33);"/>
            <rect x="396.613" y="410.972" width="30" height="17.479" style="vector-effect: non-scaling-stroke; stroke-width: 2px; fill: rgb(33, 33, 33); stroke: rgb(33, 33, 33);"/>
            <rect x="396.613" y="145.93" width="30" height="17.479" style="vector-effect: non-scaling-stroke; stroke-width: 2px; stroke: rgb(97, 97, 97); fill: rgb(117, 117, 117);"/>
            <rect x="396.613" y="393.493" width="30" height="17.479" style="vector-effect: non-scaling-stroke; stroke-width: 2px; fill: rgb(117, 117, 117); stroke: rgb(97, 97, 97);"/>
            <rect x="396.613" y="358.083" width="30" height="35.41" style="vector-effect: non-scaling-stroke; stroke-width: 2px; stroke: rgb(97, 97, 97); fill: rgb(117, 117, 117);"/>
            <rect x="396.613" y="163.409" width="30" height="35.41" style="vector-effect: non-scaling-stroke; stroke-width: 2px; fill: rgb(117, 117, 117); stroke: rgb(97, 97, 97);"/>
            <g id="T-101_level@cx_move,cx_hide">
                <path id="T-101_level_ind@cx_color" d="M -1158.042 -715.812 L -1149.042 -687.812 L -1167.042 -687.812 L -1158.042 -715.812 Z" style="fill: rgb(97, 97, 97);" transform="matrix(0, -1, 1, 0, 1112.424805, -879.590454)" bx:shape="triangle -1167.042 -715.812 18 28 0.5 0 1@2477659d"/>
            </g>
        </g>
        <g transform="matrix(1, 0, 0, 1, -144.527634, -291.399963)">
            <path id="P-101A@cx_color" d="M 1018 600 C 1018 609.941 1009.941 618 1000 618 C 990.059 618 982 609.941 982 600 C 982 590.059 990.059 582 1000 582 C 1009.941 582 1018 590.059 1018 600 Z M 1070 600 C 1070 638.66 1038.66 670 1000 670 C 961.34 670 930 638.66 930 600 C 930 561.34 961.34 530 1000 530 C 1038.66 530 1070 561.34 1070 600 Z M 997.535 530 L 1124.172 530 L 1124.172 565.577 L 1060.965 565.577 C 1048.946 544.336 1026.147 530 1000 530 C 999.175 530 998.353 530.014 997.535 530.043 L 997.535 530 Z" style="fill: rgb(216, 216, 216); stroke: rgb(117, 117, 117); stroke-width: 2px; vector-effect: non-scaling-stroke;">
                <title>Unit</title>
            </path>
            <title>Pump</title>
            <text style="fill: rgb(98, 98, 98); font-size: 26px; font-weight: 700; white-space: pre;" x="963.593" y="522.202"><title>Name</title>P-101A</text>
            <text id="P-101A@cx_status" style="fill: rgb(40, 53, 147); font-size: 26px; font-weight: 700; white-space: pre;" x="1076.706" y="662.936"><title>Status</title>Stopped</text>
        </g>
        <g id="P-101B@cx_hide" transform="matrix(1, 0, 0, 1, -144.527634, 7.183367)">
            <path id="P-101B@cx_color" d="M 1018 600 C 1018 609.941 1009.941 618 1000 618 C 990.059 618 982 609.941 982 600 C 982 590.059 990.059 582 1000 582 C 1009.941 582 1018 590.059 1018 600 Z M 1070 600 C 1070 638.66 1038.66 670 1000 670 C 961.34 670 930 638.66 930 600 C 930 561.34 961.34 530 1000 530 C 1038.66 530 1070 561.34 1070 600 Z M 997.535 530 L 1124.172 530 L 1124.172 565.577 L 1060.965 565.577 C 1048.946 544.336 1026.147 530 1000 530 C 999.175 530 998.353 530.014 997.535 530.043 L 997.535 530 Z" style="fill: rgb(216, 216, 216); stroke: rgb(117, 117, 117); stroke-width: 2px; vector-effect: non-scaling-stroke;">
                <title>Unit</title>
            </path>
            <title>Pump 2</title>
            <text style="fill: rgb(98, 98, 98); font-size: 26px; font-weight: 700; white-space: pre;" x="963.593" y="522.202">P-101B</text>
            <text style="fill: rgb(40, 53, 147); font-size: 26px; font-weight: 700; white-space: pre;" x="1076.706" y="662.936"><title>Status</title>Stopped</text>
        </g>
        <g>
            <line style="stroke: rgb(66, 66, 66);" x1="290.589" y1="480.453" x2="290.589" y2="575.261"/>
            <line style="stroke: rgb(66, 66, 66); marker-end: url(#marker-0);" x1="290.589" y1="575.261" x2="636.564" y2="575.261"/>
            <line style="stroke: rgb(66, 66, 66);" x1="636.565" y1="575.261" x2="636.565" y2="309.322"/>
            <line style="marker-end: url(#marker-0); stroke: rgb(66, 66, 66);" x1="636.564" y1="309.322" x2="852.792" y2="309.322"/>
            <line style="stroke: rgb(66, 66, 66);" x1="636.564" y1="608.497" x2="636.564" y2="575.261"/>
            <line style="stroke: rgb(66, 66, 66); marker-end: url(#marker-0);" x1="636.564" y1="608.497" x2="852.792" y2="608.497"/>
        </g>
    </svg>

    <!-- SVG FILE CONTENT ABOVE -->

    <script>
        (function($scope) {
            const cxMove = "cx_move";
            const cxColor = "cx_color";
            const cxStatus = "cx_status";
            const cxHide = "cx_hide";
            const cxStroke = "cx_stroke";
            const maxStatusLength = 100;


            $scope.checkSVG = function() {

                if (!$scope.graphicObjects) {
                    $scope.graphicObjects = [];
                }
                recursiveEach($("#graphics"), $scope.graphicObjects);
                // console.log($scope.graphicObjects);

                function recursiveEach(element, container){
                    element.children().each(function () {
                        const $currentElement = $(this);
                        if (this.id && this.id.indexOf('@') > 0) {
                            container.push({
                                id: this.id,
                                element: $currentElement,
                                cxMove: (this.id.indexOf(cxMove) > 0),
                                cxColor: (this.id.indexOf(cxColor) > 0),
                                cxStatus: (this.id.indexOf(cxStatus) > 0),
                                cxHide: (this.id.indexOf(cxHide) > 0),
                                cxStroke: (this.id.indexOf(cxStroke) > 0),
                            });
                        }
                        recursiveEach($currentElement, container);
                    });
                }
            };

            $scope.$watch('msg', function() {
                if (!$scope.msg) return;

                if (Array.isArray($scope.msg.payload)) {
                    for (let aReq of $scope.msg.payload) {
                        animateObject(aReq.payload, aReq.topic);
                    }
                } else {
                    animateObject($scope.msg.payload, $scope.msg.topic);
                }
            });

            function animateObject(payload, topic) {

                if (payload === undefined || payload === null || !topic || typeof topic !== 'string' || !topic.includes('@')) return null;
                
                // id and command of the current searched object.
                const id = topic.split('@')[0];
                const cxType = topic.split('@')[1];
                const cxTypeParts = cxType.split(',');

                for (const graphicObject of $scope.graphicObjects) {  // Loop through all the objects in the image .svg
                    const objId = graphicObject.id.split('@')[0];
                    if (objId !== id) continue;  // If it is not the object searched, skip the next block of code.
                    
                    for (const cxt of cxTypeParts) {
                        if (cxt === cxColor && typeof payload === 'string') {
                            graphicObject.element.css({fill : payload});  // msg.payload = "color"
                            
                        } else if (cxt === cxColor) {
                            if (payload.color != null) graphicObject.element.css({fill: payload.color});  // msg.payload = {color: "color"}
                            
                        } else if (cxt === cxStatus && typeof payload === 'string') {
                            const statusText = (payload.length > maxStatusLength) ? payload.substring(0, maxStatusLength - 3) + '...' : payload;
    
                            graphicObject.element.text(statusText);
    
                        } else if (cxt === cxHide && typeof payload === 'boolean') {
                            const displayAttr = (payload)? 'none' : '';
                            
                            graphicObject.element.css({display: displayAttr})
    
                        } else if (cxt === cxMove) {
                            // box = SVGRect {x: 51.95399475097656, y: 54.69599914550781, width: 94.41000366210938, height: 94.41000366210938}
                            const box = graphicObject.element[0].getBBox();
                            const matrix = getMatrix(payload, box);
                            if (matrix) graphicObject.element.attr('transform', matrix);
    
                        } else if (cxt === cxStroke) {
                            // const displayAttr = (payload)? 'none' : '';
                            if (payload.color != null) graphicObject.element.css({stroke: payload.color});
                            if (payload.width != null) graphicObject.element.css({["stroke-width"]: payload.width});
                        }
                    }
                }
            }


            function getMatrix(config, box) {
                if (!config || !box) return;

                // translation
                const tx = config.x || 0;
                const ty = config.y || 0;
                // angle in radians
                const rads = config.deg * (Math.PI / 180) || 0;
                // rotation centre
                // box = { x: 51.95399475097656, y: 54.69599914550781, width: 94.41000366210938, height: 94.41000366210938 }
                const pivot_x = (config.pivot && config.pivot[0])? config.pivot[0] : 0;
                const pivot_y = (config.pivot && config.pivot[1])? config.pivot[1] : 0;
                const cx = box.x + box.width * ( (pivot_x)? pivot_x : 0.5 );
                const cy = box.y + box.height * ( (pivot_y)? pivot_y : 0 );
                // scaling
                const sx = 1;
                const sy = 1;

                // matrix(0.594088, -0.516432, 0.62601, 0.720144, -223.586029, 145.949615)
                return 'matrix(' +
                    (sx * Math.cos(rads)) + ', ' + (sy * Math.sin(rads)) + ', ' +
                    (-sx * Math.sin(rads)) + ', ' + (sy * Math.cos(rads)) + ', ' +
                    ((-Math.cos(rads) * cx + Math.sin(rads) * cy + cx) * sx + tx) + ', ' +
                    ((-Math.sin(rads) * cx - Math.cos(rads) * cy + cy) * sy + ty) + ')';
            }

        })(scope);
    </script>
</div>
